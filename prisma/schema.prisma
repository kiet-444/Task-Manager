// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Uncomment the following block if you use Prisma <5.10
// datasource db {
//   provider = "postgresql"
//   url      = env("DATABASE_URL_UNPOOLED")
// }
// Define your database schema here 

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  //relationship with task assigned to user
  createdTasks       Task[]               @relation("CreatedTasks")
  assignedTasks      Task[]               @relation("AssignedTasks")
  Comment            Comment[]
  UserOnConversation UserOnConversation[]
  Message            Message[]
  projects           Project[]
  projectMembers     ProjectMember[]
  activities         Activity[]
  projectAudits      ProjectAudit[]
  projectActivities  ProjectActivity[]
  projectInvites     ProjectInvite[]
  auditLogs          AuditLog[]
}

model Task {
  id           Int        @id @default(autoincrement())
  title        String
  description  String?
  status       TaskStatus @default(TODO)
  dueDate      DateTime?
  completed    Boolean    @default(false)
  reminderSent Boolean    @default(false)

  userId Int
  user   User @relation("CreatedTasks", fields: [userId], references: [id])

  priority TaskPriority @default(LOW)

  //relationship with task assigned to users
  assignedToId Int?
  assignedTo   User? @relation("AssignedTasks", fields: [assignedToId], references: [id])

  Comment    Comment[]
  project    Project?   @relation(fields: [projectId], references: [id])
  projectId  Int?
  activities Activity[]
  taskTags   TaskTag[]

  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TaskPriority {
  LOW
  MEDIUM
  HARD
}

enum TaskStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  TODO
  DONE
  CANCELLED
}

model Tag {
  id    Int       @id @default(autoincrement())
  name  String
  color String?
  tasks TaskTag[]
}

model TaskTag {
  taskId Int
  tagId  Int

  task Task @relation(fields: [taskId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id])

  @@id([taskId, tagId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  taskId Int
  task   Task @relation(fields: [taskId], references: [id])

  // (optional)
  parentId Int?
  parent   Comment?  @relation("CommentToReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentToReplies")

  updatedAt DateTime @updatedAt
}

model UserOnConversation {
  userId Int
  user   User @relation(fields: [userId], references: [id])

  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  joinedAt       DateTime     @default(now())

  @@id([userId, conversationId])
}

model Message {
  id      Int    @id @default(autoincrement())
  content String

  senderId Int
  sender   User @relation(fields: [senderId], references: [id])

  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id])

  deletedAt DateTime?

  readAt    DateTime?
  createdAt DateTime  @default(now())
}

model Conversation {
  id           Int                  @id @default(autoincrement())
  name         String?
  participants UserOnConversation[]
  messages     Message[]
  type         ConversationType     @default(PROJECT)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
}

enum ConversationType {
  PROJECT
  PERSONAL
  GROUP
}

model Project {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  startDate   DateTime?
  endDate     DateTime?

  createById Int
  createdBy  User @relation(fields: [createById], references: [id])

  members ProjectMember[]
  task    Task[]

  deletedAt DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  projectAudits     ProjectAudit[]
  activities        Activity[]
  projectActivities ProjectActivity[]
  projectInvites    ProjectInvite[]
  auditLogs         AuditLog[]
}

model ProjectMember {
  id        Int     @id @default(autoincrement())
  projectId Int
  project   Project @relation(fields: [projectId], references: [id])

  userId Int
  user   User @relation(fields: [userId], references: [id])

  role      Role     @default(VIEWER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectAudit {
  id Int @id @default(autoincrement())

  projectId Int
  project   Project @relation(fields: [projectId], references: [id])

  action    String
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  updatedAt DateTime @updatedAt
}

enum Role {
  VIEWER
  ADMIN
  MEMBER
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
}

model ResetToken {
  identifier String
  token      String   @unique
  expires    DateTime
}

model Notification {
  id     Int @id @default(autoincrement())
  userId Int

  type    NotificationType @default(TASK_ASSIGNED)
  title   String
  content String

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum NotificationType {
  TASK_ASSIGNED
  NEW_COMMENT
  NEW_MESSAGE
}

model Activity {
  id Int @id @default(autoincrement())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  action     String
  actionType ActivityAction @default(CREATE_TASK)

  projectId Int?
  project   Project? @relation(fields: [projectId], references: [id])

  taskId Int?
  task   Task? @relation(fields: [taskId], references: [id])

  createdAt         DateTime          @default(now())
  projectActivities ProjectActivity[]
}

enum ActivityAction {
  CREATE_TASK
  UPDATE_TASK
  DELETE_TASK
  CREATE_PROJECT
  UPDATE_PROJECT
  DELETE_PROJECT
  CREATE_MESSAGE
  UPDATE_MESSAGE
  DELETE_MESSAGE
}

model ProjectActivity {
  id Int @id @default(autoincrement())

  projectId Int
  project   Project @relation(fields: [projectId], references: [id])

  email String
  token String @unique
  role  Role   @default(MEMBER)

  expires DateTime
  used    Boolean  @default(false)

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?
  activity   Activity? @relation(fields: [activityId], references: [id])
  activityId Int?
}

model ProjectInvite {
  id Int @id @default(autoincrement())

  projectId Int
  project   Project @relation(fields: [projectId], references: [id])

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])

  email String?
  token String  @unique
  role  Role    @default(MEMBER)

  expiresAt DateTime
  used      Boolean  @default(false)

  createdAt DateTime @default(now())
}

model AuditLog {
  id Int @id @default(autoincrement())

  projectId Int
  userId    Int?

  action String
  meta   Json?

  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id])
  user    User?   @relation(fields: [userId], references: [id])
}
